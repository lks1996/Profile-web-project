<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ìƒì„¸ í¸ì§‘</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}"/>
    <style>
        body { background-color: #f4f5f7; }
        .editor-container { max-width: 900px; margin: 40px auto; }
        .section-card { background: white; border-radius: 8px; padding: 30px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-header { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .sub-item { background-color: #f8f9fa; border-left: 4px solid #3366ff; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .btn-add { font-size: 0.85rem; font-weight: 600; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

<div class="editor-container">
    <form th:action="@{/admin/projects/save}" th:object="${project}" method="post" id="projectForm">
        <input type="hidden" th:field="*{id}">

        <div class="section-card">
            <h3 class="section-header">ê¸°ë³¸ ì •ë³´</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">íšŒì‚¬/ì†Œì†</label>
                    <select th:field="*{company}" class="form-select">
                        <option th:each="comp : ${companies}" th:value="${comp.id}" th:text="${comp.name}"></option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">í”„ë¡œì íŠ¸ëª…</label>
                    <input type="text" th:field="*{title}" class="form-control" placeholder="í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">ì •ë ¬ ìˆœì„œ</label>
                    <input type="number" th:field="*{sortOrder}" class="form-control">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check form-switch mb-2 ms-2">
                        <input type="checkbox" th:field="*{visible}" class="form-check-input" id="visible">
                        <label class="form-check-label" for="visible">ì´ë ¥ì„œ ë…¸ì¶œ</label>
                    </div>
                </div>
            </div>
        </div>

        <div th:each="meta, metaStat : *{metaItems}">
            <input type="hidden" th:field="*{metaItems[__${metaStat.index}__].itemType}">
            <input type="hidden" th:field="*{metaItems[__${metaStat.index}__].sortOrder}">
            <input type="hidden" th:field="*{metaItems[__${metaStat.index}__].visible}" value="true">

            <div class="section-card" th:if="${meta.itemType == 'DURATION'}">
                <h3 class="section-header">í”„ë¡œì íŠ¸ ê¸°ê°„ ë° ìš”ì•½</h3>
                <div class="mb-3">
                    <label class="form-label">ê¸°ê°„ (ì˜ˆ: 2023.01 - 2023.06)</label>
                    <input type="text" th:field="*{metaItems[__${metaStat.index}__].content}" class="form-control" placeholder="YYYY.MM - YYYY.MM">
                </div>
            </div>

            <div class="section-card" th:if="${meta.itemType == 'TECH_STACK_GROUP'}">
                <h3 class="section-header">ì‚¬ìš© ê¸°ìˆ  (Tech Stack)</h3>
                <div id="techStackContainer">
                    <div th:each="stack, stackStat : ${meta.techStacks}" class="input-group mb-2">
                        <input type="text"
                               th:name="|metaItems[${metaStat.index}].techStacks[${stackStat.index}].techName|"
                               th:value="${stack.techName}"
                               class="form-control" placeholder="ê¸°ìˆ ëª… (ì˜ˆ: Java, Spring Boot)">
                        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">ì‚­ì œ</button>
                        <input type="hidden" th:name="|metaItems[${metaStat.index}].techStacks[${stackStat.index}].sortOrder|" value="0">
                        <input type="hidden" th:name="|metaItems[${metaStat.index}].techStacks[${stackStat.index}].visible|" value="true">
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-add mt-2"
                        th:onclick="|addTechStack(${metaStat.index})|">+ ê¸°ìˆ  ì¶”ê°€</button>
            </div>

            <div class="section-card" th:if="${meta.itemType == 'CONTENT_GROUP'}">
                <h3 class="section-header">ìƒì„¸ ì—…ë¬´ ì„±ê³¼ (Episodes)</h3>

                <div th:id="|problemContainer_${metaStat.index}|">
                    <div th:each="problem, probStat : ${meta.problems}" class="sub-item">
                        <div class="mb-3">
                            <label class="form-label text-primary">ğŸ“Œ ì£¼ìš” ì—…ë¬´/ë¬¸ì œ ì •ì˜ (Problem)</label>
                            <input type="text"
                                   th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].title|"
                                   th:value="${problem.title}"
                                   class="form-control fw-bold" placeholder="ì–´ë–¤ ë¬¸ì œë¥¼ í•´ê²°í–ˆë‚˜ìš”?">
                            <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].sortOrder|" value="0">
                            <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].visible|" value="true">
                        </div>

                        <div class="ms-3 border-start ps-3 mb-3">
                            <label class="form-label small text-muted">í•´ê²° ê³¼ì • (Solutions)</label>
                            <div th:id="|solContainer_${metaStat.index}_${probStat.index}|">
                                <div th:each="sol, solStat : ${problem.solutions}" class="input-group mb-1">
                                    <span class="input-group-text bg-white">â€¢</span>
                                    <input type="text"
                                           th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].solutions[${solStat.index}].content|"
                                           th:value="${sol.content}"
                                           class="form-control" placeholder="í•´ê²°ì±… ì…ë ¥">
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">X</button>
                                    <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].solutions[${solStat.index}].visible|" value="true">
                                    <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].solutions[${solStat.index}].sortOrder|" value="0">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-light text-primary mt-1"
                                    th:onclick="|addSolution(${metaStat.index}, ${probStat.index})|">+ í•´ê²°ì±… ì¶”ê°€</button>
                        </div>

                        <div class="ms-3 border-start ps-3">
                            <label class="form-label small text-muted">ê²°ê³¼ ë° ì„±ê³¼ (Impacts)</label>
                            <div th:id="|impContainer_${metaStat.index}_${probStat.index}|">
                                <div th:each="imp, impStat : ${problem.impacts}" class="input-group mb-1">
                                    <span class="input-group-text bg-white">ğŸ“ˆ</span>
                                    <input type="text"
                                           th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].impacts[${impStat.index}].content|"
                                           th:value="${imp.content}"
                                           class="form-control" placeholder="ì„±ê³¼ ì…ë ¥ (ì˜ˆ: ì„±ëŠ¥ 30% í–¥ìƒ)">
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">X</button>
                                    <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].impacts[${impStat.index}].visible|" value="true">
                                    <input type="hidden" th:name="|metaItems[${metaStat.index}].problems[${probStat.index}].impacts[${impStat.index}].sortOrder|" value="0">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-light text-success mt-1"
                                    th:onclick="|addImpact(${metaStat.index}, ${probStat.index})|">+ ì„±ê³¼ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-dark w-100 mt-3"
                        th:onclick="|addProblem(${metaStat.index})|">+ ìƒˆë¡œìš´ ì—í”¼ì†Œë“œ(Problem) ì¶”ê°€</button>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-4 mb-5">
            <a th:href="@{/admin/projects}" class="btn btn-secondary me-2">ì·¨ì†Œ</a>
            <button type="submit" class="btn btn-primary btn-lg">ì „ì²´ ì €ì¥</button>
        </div>
    </form>
</div>

<script>
    // ì¸ë±ìŠ¤ ê´€ë¦¬ë¥¼ ìœ„í•´ í˜„ì¬ ì‹œê°„ì„ í™œìš©í•˜ê±°ë‚˜ ì¹´ìš´í„°ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ DOM ìš”ì†Œ ê°œìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    function addTechStack(metaIndex) {
        const container = document.getElementById('techStackContainer');
        const count = container.children.length;
        const html = `
            <div class="input-group mb-2">
                <input type="text" name="metaItems[${metaIndex}].techStacks[${count}].techName" class="form-control" placeholder="ìƒˆ ê¸°ìˆ ëª…">
                <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">ì‚­ì œ</button>
                <input type="hidden" name="metaItems[${metaIndex}].techStacks[${count}].visible" value="true">
                <input type="hidden" name="metaItems[${metaIndex}].techStacks[${count}].sortOrder" value="${count}">
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function addSolution(metaIndex, probIndex) {
        const container = document.getElementById(`solContainer_${metaIndex}_${probIndex}`);
        const count = container.querySelectorAll('.input-group').length; // ì •í™•í•œ ê°œìˆ˜ íŒŒì•…
        // ì£¼ì˜: name ì†ì„±ì˜ ì¸ë±ìŠ¤ê°€ ì¤‘ë³µë˜ë©´ ì•ˆë˜ë¯€ë¡œ, timestampë¥¼ ì“°ê±°ë‚˜ ì •í™•í•œ length ê³„ì‚° í•„ìš”
        // Spring ë°”ì¸ë”©ì€ ì¸ë±ìŠ¤ê°€ ì—°ì†ì ì´ì§€ ì•Šì•„ë„(ì˜ˆ: 0, 2, 5) Listë¡œ ì˜ ë°›ì•„ì£¼ì§€ë§Œ, AutoPopulateList ê¸°ëŠ¥ì„ ìœ„í•´ ê°€ê¸‰ì  ìˆœì°¨ì ì´ ì¢‹ìŠµë‹ˆë‹¤.

        const html = `
            <div class="input-group mb-1">
                <span class="input-group-text bg-white">â€¢</span>
                <input type="text" name="metaItems[${metaIndex}].problems[${probIndex}].solutions[${count}].content" class="form-control" placeholder="ì¶”ê°€ í•´ê²°ì±…">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">X</button>
                <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].solutions[${count}].visible" value="true">
                <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].solutions[${count}].sortOrder" value="${count}">
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function addImpact(metaIndex, probIndex) {
        const container = document.getElementById(`impContainer_${metaIndex}_${probIndex}`);
        const count = container.querySelectorAll('.input-group').length;

        const html = `
            <div class="input-group mb-1">
                <span class="input-group-text bg-white">ğŸ“ˆ</span>
                <input type="text" name="metaItems[${metaIndex}].problems[${probIndex}].impacts[${count}].content" class="form-control" placeholder="ì¶”ê°€ ì„±ê³¼">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">X</button>
                <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].impacts[${count}].visible" value="true">
                <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].impacts[${count}].sortOrder" value="${count}">
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function addProblem(metaIndex) {
        const container = document.getElementById(`problemContainer_${metaIndex}`);
        const probIndex = container.children.length; // ìƒˆë¡œìš´ ë¬¸ì œ ì¸ë±ìŠ¤

        const html = `
            <div class="sub-item">
                <div class="mb-3">
                    <label class="form-label text-primary">ğŸ“Œ ìƒˆ ì£¼ìš” ì—…ë¬´/ë¬¸ì œ ì •ì˜ (Problem)</label>
                    <input type="text" name="metaItems[${metaIndex}].problems[${probIndex}].title" class="form-control fw-bold" placeholder="ìƒˆë¡œìš´ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].visible" value="true">
                    <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].sortOrder" value="${probIndex}">
                </div>
                <div class="ms-3 border-start ps-3 mb-3">
                    <label class="form-label small text-muted">í•´ê²° ê³¼ì •</label>
                    <div id="solContainer_${metaIndex}_${probIndex}">
                         <div class="input-group mb-1">
                             <span class="input-group-text bg-white">â€¢</span>
                             <input type="text" name="metaItems[${metaIndex}].problems[${probIndex}].solutions[0].content" class="form-control" placeholder="í•´ê²°ì±… ì…ë ¥">
                             <input type="hidden" name="metaItems[${metaIndex}].problems[${probIndex}].solutions[0].visible" value="true">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-light text-primary mt-1" onclick="addSolution(${metaIndex}, ${probIndex})">+ í•´ê²°ì±… ì¶”ê°€</button>
                </div>
                <div class="ms-3 border-start ps-3">
                    <label class="form-label small text-muted">ì„±ê³¼</label>
                    <div id="impContainer_${metaIndex}_${probIndex}"></div>
                    <button type="button" class="btn btn-sm btn-light text-success mt-1" onclick="addImpact(${metaIndex}, ${probIndex})">+ ì„±ê³¼ ì¶”ê°€</button>
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }
</script>

</body>
</html>